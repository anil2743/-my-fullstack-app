name: CI/CD Deploy React + Spring Boot to EC2 (Staging & Prod)

on:
  push:
    branches: [ staging, main, master ]
  pull_request:
    branches: [ staging ]

jobs:
  ###############################################################
  #  BUILD JOB
  ###############################################################
  build:
    name: Build frontend & backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ✅ Build frontend for BOTH staging and prod
      - name: Build Frontend (React)
        run: |
          cd frontend
          npm ci
          npm run build:staging
          npm run build:prod

      # ✅ Build backend
      - name: Build Backend (Spring Boot)
        run: |
          cd backend
          mvn -B -q -DskipTests clean package

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-and-jar
          path: |
            frontend/build-staging
            frontend/build-prod
            backend/target/*.jar

  ###############################################################
  #  STAGING DEPLOY
  ###############################################################
  deploy-staging:
    name: Deploy to STAGING EC2
    needs: build
    runs-on: ubuntu-latest
    if: >
      (github.ref == 'refs/heads/staging' && github.event_name == 'push') ||
      (github.event_name == 'pull_request' && github.base_ref == 'staging')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-and-jar
          path: ./build-artifacts

      - name: Copy to EC2 (staging)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build-artifacts"
          target: "/home/${{ secrets.EC2_USER }}/staging/"

      - name: Deploy Staging
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            STAGING_WEB="/var/www/html/staging"
            mkdir -p "$STAGING_WEB"
            mkdir -p ~/staging

            echo "=== Deploying STAGING ==="

            # Clean only the web files inside /staging/, not the directory itself
            sudo rm -rf "$STAGING_WEB"/*
            sudo cp -r ~/staging/build-artifacts/frontend/build-staging/* "$STAGING_WEB"/
            sudo chown -R www-data:www-data "$STAGING_WEB"

            # Update staging jar
            cp ~/staging/build-artifacts/backend/target/*.jar ~/staging/app-staging.jar
            sudo systemctl restart staging

            echo "✅ STAGING DEPLOY done"

  ###############################################################
  #  PRODUCTION DEPLOY
  ###############################################################
  deploy-production:
    name: Deploy to PRODUCTION EC2
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' &&
        (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-and-jar
          path: ./build-artifacts

      - name: Copy to EC2 (production)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build-artifacts"
          target: "/home/${{ secrets.EC2_USER }}/app/"

      - name: Deploy Production
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            PROD_WEB="/var/www/html"
            mkdir -p "$PROD_WEB"
            mkdir -p ~/app

            echo "=== Deploying PRODUCTION ==="

            # ⚠️ DO NOT remove the /staging folder
            # Delete only files and symlinks in the root of /var/www/html
            sudo find "$PROD_WEB" -maxdepth 1 -type f -delete
            sudo find "$PROD_WEB" -maxdepth 1 -type l -delete

            # Copy new production build
            sudo cp -r ~/app/build-artifacts/frontend/build-prod/* "$PROD_WEB"/
            sudo chown -R www-data:www-data "$PROD_WEB"

            # Update prod jar
            cp ~/app/build-artifacts/backend/target/*.jar ~/app/app.jar
            sudo systemctl restart prod

            # Optional: quick nginx reload if configs changed
            sudo nginx -t && sudo systemctl reload nginx || true

            echo "✅ PRODUCTION DEPLOY done"
            echo "✅ URL: https://banking.cyetechnology.com"
