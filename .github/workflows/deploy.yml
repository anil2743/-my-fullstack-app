name: Build and Deploy to EKS

on:
  push:
    branches: [ master ]

env:
  AWS_REGION: ap-south-1
  EKS_CLUSTER_NAME: my-fullstack-cluster
  ECR_REPOSITORY_FRONTEND: my-frontend
  ECR_REPOSITORY_BACKEND: my-backend

jobs:
  deploy:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1

    - name: Get ECR Frontend URI
      id: ecr-frontend
      run: |
        FRONTEND_IMAGE_URI=$(aws ecr describe-repositories --repository-names $ECR_REPOSITORY_FRONTEND --query "repositories[0].repositoryUri" --output text)
        echo "::set-output name=uri::$FRONTEND_IMAGE_URI"

    - name: Get ECR Backend URI
      id: ecr-backend
      run: |
        BACKEND_IMAGE_URI=$(aws ecr describe-repositories --repository-names $ECR_REPOSITORY_BACKEND --query "repositories[0].repositoryUri" --output text)
        echo "::set-output name=uri::$BACKEND_IMAGE_URI"

    - name: Build and Push Frontend Docker Image
      run: |
        FRONTEND_IMAGE_URI="${{ steps.ecr-frontend.outputs.uri }}"
        cd frontend
        docker build -t $FRONTEND_IMAGE_URI:latest .
        docker push $FRONTEND_IMAGE_URI:latest

    - name: Build Backend JAR
      run: |
        cd backend
        mvn clean package -DskipTests

    - name: Build and Push Backend Docker Image
      run: |
        BACKEND_IMAGE_URI="${{ steps.ecr-backend.outputs.uri }}"
        cd backend
        docker build -t $BACKEND_IMAGE_URI:latest .
        docker push $BACKEND_IMAGE_URI:latest

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME

    - name: Deploy to EKS
      run: |
        # Update the image URIs in the deployment files
        sed -i "s|145023139102.dkr.ecr.ap-south-1.amazonaws.com/my-backend:latest|${{ steps.ecr-backend.outputs.uri }}:latest|g" k8s/backend-deployment.yaml
        sed -i "s|145023139102.dkr.ecr.ap-south-1.amazonaws.com/my-frontend:latest|${{ steps.ecr-frontend.outputs.uri }}:latest|g" k8s/frontend-deployment.yaml
        # Apply the manifests
        kubectl apply -f k8s/backend-deployment.yaml
        kubectl apply -f k8s/backend-service.yaml
        kubectl apply -f k8s/frontend-deployment.yaml
        kubectl apply -f k8s/frontend-service.yaml