name: CI/CD Deploy React + Spring Boot to EC2 (Staging & Prod)

on:
  push:
    branches: [ staging, main, master ]
  pull_request:
    branches: [ staging ]

jobs:
  build:
    name: Build backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build Backend (Spring Boot)
        run: |
          cd backend
          mvn -B -q -DskipTests clean package
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: |
            backend/target/*.jar

  deploy-staging:
    name: Deploy to STAGING EC2
    needs: build
    runs-on: ubuntu-latest
    if: >
      (github.ref == 'refs/heads/staging' && github.event_name == 'push') ||
      (github.event_name == 'pull_request' && github.base_ref == 'staging' && 
       github.event.pull_request.head.repo.full_name == github.repository)
    environment: staging

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: Prepare backend JAR
        run: |
          JAR_PATH=$(ls ./backend-jar/*.jar | head -1)
          cp "$JAR_PATH" ./staging-backend.jar
          echo "Prepared JAR: ./staging-backend.jar"

      - name: Build Frontend (Staging) - FIXED
        run: |
          cd frontend
          npm ci
          # Set PUBLIC_URL for staging environment
          CI=false PUBLIC_URL=/staging/ npm run build:staging
          
      - name: Check built frontend
        run: |
          echo "=== Checking built frontend ==="
          ls -la frontend/build/
          echo "=== Checking index.html ==="
          head -20 frontend/build/index.html
          echo "=== Checking asset paths ==="
          grep -E 'href="[^"]*\.js|src="[^"]*\.js"' frontend/build/index.html | head -5

      - name: Prepare frontend artifact
        run: |
          mkdir -p build-artifacts/frontend/build
          cp -r frontend/build/* build-artifacts/frontend/build/

      - name: List artifacts
        run: |
          echo "=== Listing backend JAR ==="
          ls -la ./staging-backend.jar
          echo "=== Listing frontend build contents ==="
          ls -la build-artifacts/frontend/build

      - name: Clean staging dir on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            rm -rf ~/staging/*
            mkdir -p ~/staging/frontend
            mkdir -p ~/staging/backend

      - name: Copy frontend to EC2 (staging) - FIXED
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Use rsync to copy frontend files
          rsync -avz -e "ssh -o StrictHostKeyChecking=no" build-artifacts/frontend/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/staging/frontend/

      - name: Copy backend JAR to EC2 (staging)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "staging-backend.jar"
          target: "/home/${{ secrets.EC2_USER }}/staging/backend/"

      - name: Verify files on EC2 (staging)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Verifying files on EC2 ==="
            echo "Contents of ~/staging:"
            ls -la ~/staging
            echo "Contents of ~/staging/frontend:"
            ls -la ~/staging/frontend
            echo "Contents of ~/staging/backend:"
            ls -la ~/staging/backend
            echo "Contents of ~/staging/frontend/build:"
            ls -la ~/staging/frontend/build
            echo "Contents of ~/staging/backend/*.jar:"
            ls -la ~/staging/backend/*.jar

      - name: Fix Nginx Configuration (Staging) - IMPROVED
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "== Fixing Nginx Configuration for Staging =="
            
            # Create corrected staging configuration
            sudo tee /etc/nginx/sites-available/staging > /dev/null <<EOF
            server {
                listen 80 default_server;
                server_name _;

                # STAGING API
                location ^~ /staging/api/ {
                    proxy_pass http://127.0.0.1:8081;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                }

                # EXACT MATCH /staging → redirect to /staging/
                location = /staging {
                    return 302 /staging/;
                }

                # Static assets handling - FIXED
                location ~* ^/staging/.*\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                    alias /var/www/html/staging/;
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }

                # STAGING FRONTEND - FIXED
                location ^~ /staging/ {
                    alias /var/www/html/staging/;
                    try_files \$uri \$uri/ /index.html;
                    
                    # Add headers to help with debugging
                    add_header X-Debug-Location "staging-frontend" always;
                }
            }
            EOF
            
            # Enable staging site
            if [ ! -L "/etc/nginx/sites-enabled/staging" ]; then
              sudo ln -s /etc/nginx/sites-available/staging /etc/nginx/sites-enabled/
            fi
            
            # Remove default site if exists
            if [ -L "/etc/nginx/sites-enabled/default" ]; then
              sudo rm /etc/nginx/sites-enabled/default
            fi
            
            # Test Nginx configuration
            sudo nginx -t
            if [ $? -ne 0 ]; then
              echo "ERROR: Nginx configuration test failed"
              exit 1
            else
              echo "✓ Nginx configuration test passed"
            fi

      - name: Deploy on EC2 (staging) - IMPROVED
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            NGINX_ROOT="/var/www/html"
            STAGING_DIR="$NGINX_ROOT/staging"
            STAGING_SERVICE="staging.service"
            JAR_FILE="app-staging.jar"
            echo "== Staging deploy start =="
            
            # List staging contents for debug
            echo "=== Contents of $HOME/staging ==="
            ls -la "$HOME/staging"
            echo "=== Contents of $HOME/staging/frontend ==="
            ls -la "$HOME/staging/frontend"
            echo "=== Contents of $HOME/staging/backend ==="
            ls -la "$HOME/staging/backend"
            echo "=== Contents of $HOME/staging/frontend/build ==="
            ls -la "$HOME/staging/frontend/build"
            
            # Check directories exist
            if [ ! -d "$HOME/staging/frontend" ]; then
                echo "ERROR: frontend directory not found"
                ls -la "$HOME/staging"
                exit 1
            fi
            
            if [ ! -d "$HOME/staging/backend" ]; then
                echo "ERROR: backend directory not found"
                ls -la "$HOME/staging"
                exit 1
            fi
            
            # Check if frontend build exists
            if [ ! -d "$HOME/staging/frontend/build" ]; then
                echo "ERROR: frontend build directory not found"
                ls -la "$HOME/staging/frontend"
                exit 1
            fi
            
            # Check if index.html exists in build
            if [ ! -f "$HOME/staging/frontend/build/index.html" ]; then
                echo "ERROR: index.html not found in build directory"
                ls -la "$HOME/staging/frontend/build"
                exit 1
            fi
            
            # Check index.html content
            echo "=== Checking index.html content ==="
            if [ -s "$HOME/staging/frontend/build/index.html" ]; then
                echo "✓ index.html has content"
                echo "File size: $(stat -c%s "$HOME/staging/frontend/build/index.html") bytes"
                echo "First 10 lines:"
                head -n 10 "$HOME/staging/frontend/build/index.html"
            else
                echo "✗ index.html is empty or missing"
                ls -la "$HOME/staging/frontend/build/index.html"
            fi
            
            # Frontend deployment - IMPROVED
            sudo mkdir -p "$STAGING_DIR"
            sudo rm -rf "$STAGING_DIR"/*
            sudo cp -r "$HOME/staging/frontend/build"/* "$STAGING_DIR"/
            sudo chown -R www-data:www-data "$STAGING_DIR"
            
            # Verify frontend files
            if [ ! -f "$STAGING_DIR/index.html" ]; then
                echo "ERROR: index.html not found in $STAGING_DIR"
                ls -la "$STAGING_DIR"
                exit 1
            fi
            
            # Check asset paths in deployed index.html
            echo "=== Checking asset paths in deployed index.html ==="
            if grep -q 'href="/staging/' "$STAGING_DIR/index.html"; then
                echo "✓ Asset paths correctly prefixed with /staging/"
            else
                echo "⚠ Warning: Asset paths may not be correctly prefixed"
                echo "Sample asset paths:"
                grep -E 'href="[^"]*\.js|src="[^"]*\.js' "$STAGING_DIR/index.html" | head -3
            fi
            
            # Backend deployment
            if [ -f "$HOME/staging/backend"/*.jar ]; then
                cp "$HOME/staging/backend"/*.jar "$HOME/staging/$JAR_FILE"
                echo "JAR copied successfully to $JAR_FILE"
            else
                echo "ERROR: JAR file not found"
                ls -la "$HOME/staging/backend"
                exit 1
            fi
            
            # Check if systemd service exists
            if [ ! -f "/etc/systemd/system/${STAGING_SERVICE}" ]; then
                echo "ERROR: Systemd service ${STAGING_SERVICE} not found"
                ls -la /etc/systemd/system/
                exit 1
            fi
            
            # Restart services
            sudo systemctl restart nginx
            sudo systemctl restart ${STAGING_SERVICE}
            
            # Wait for services to start
            sleep 5
            
            # Check service status
            sudo systemctl status ${STAGING_SERVICE} --no-pager -n 20
            
            # Test staging site comprehensively
            echo "=== Testing staging site ==="
            
            # Test 1: Check HTTP status
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/staging/)
            echo "HTTP Status Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
                echo "✓ Staging site is accessible"
                
                # Test 2: Check content
                CONTENT=$(curl -s http://localhost/staging/)
                if [ -z "$CONTENT" ]; then
                    echo "⚠ Warning: Staging site returned empty content"
                    
                    # Test 3: Check if index.html exists on server
                    if [ -f "$STAGING_DIR/index.html" ]; then
                        echo "✓ index.html exists on server"
                        echo "Size: $(stat -c%s "$STAGING_DIR/index.html") bytes"
                        
                        # Test 4: Check index.html content on server
                        if [ -s "$STAGING_DIR/index.html" ]; then
                            echo "✓ index.html has content on server"
                            echo "First 300 characters:"
                            head -c 300 "$STAGING_DIR/index.html"
                            
                            # Test 5: Check Nginx error logs
                            echo "=== Nginx error logs ==="
                            sudo tail -n 30 /var/log/nginx/error.log
                            
                            # Test 6: Check if React app is loading
                            echo "=== Checking for React app loading issues ==="
                            if grep -q "react-app" "$STAGING_DIR/index.html"; then
                                echo "✓ React app root found in index.html"
                            else
                                echo "⚠ Warning: React app root not found in index.html"
                                echo "This might indicate a build issue"
                            fi
                            
                            # Test 7: Check asset loading
                            echo "=== Checking asset loading ==="
                            ASSET_URL=$(grep -oP 'href="\K[^"]*\.js[^"]*' "$STAGING_DIR/index.html" | head -1)
                            if [ -n "$ASSET_URL" ]; then
                                echo "Testing asset: $ASSET_URL"
                                ASSET_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost$ASSET_URL")
                                echo "Asset HTTP Status: $ASSET_CODE"
                                if [ "$ASSET_CODE" != "200" ]; then
                                    echo "⚠ Warning: Asset not loading properly"
                                fi
                            fi
                        else
                            echo "✗ index.html is empty on server"
                        fi
                    else
                        echo "✗ index.html does not exist on server"
                        echo "Contents of $STAGING_DIR:"
                        ls -la "$STAGING_DIR"
                    fi
                else
                    echo "✓ Staging site has content"
                    echo "First 100 characters:"
                    echo "$CONTENT" | head -c 100
                fi
            else
                echo "✗ Staging site returned HTTP $HTTP_CODE"
                echo "=== Nginx error logs ==="
                sudo tail -n 30 /var/log/nginx/error.log
                echo "=== Checking if index.html exists ==="
                if [ -f "$STAGING_DIR/index.html" ]; then
                    echo "✓ index.html exists"
                    echo "Size: $(stat -c%s "$STAGING_DIR/index.html") bytes"
                else
                    echo "✗ index.html does not exist"
                    echo "Contents of $STAGING_DIR:"
                    ls -la "$STAGING_DIR"
                fi
            fi
            
            # Test 8: Check backend API
            echo "=== Testing backend API ==="
            API_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/staging/api/actuator/health || curl -s -o /dev/null -w "%{http_code}" http://localhost/staging/api/health)
            echo "API HTTP Status Code: $API_HTTP_CODE"
            
            # Test 9: Check Nginx access logs for asset 404s
            echo "=== Checking Nginx access logs for asset 404s ==="
            sudo tail -n 100 /var/log/nginx/access.log | grep ' 404 ' | grep -E '\.(js|css|png|jpg|jpeg|gif|ico|svg)' || echo "No asset 404s found"
            
            echo "== Staging deploy done =="
            echo "Staging URLs:"
            echo "  Frontend: http://${{ secrets.EC2_HOST }}/staging"
            echo "  Backend API: http://${{ secrets.EC2_HOST }}/staging/api"

  deploy-production:
    name: Deploy to PRODUCTION EC2
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment: production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: Prepare backend JAR
        run: |
          JAR_PATH=$(ls ./backend-jar/*.jar | head -1)
          cp "$JAR_PATH" ./prod-backend.jar
          echo "Prepared JAR: ./prod-backend.jar"

      - name: Build Frontend (Production)
        run: |
          cd frontend
          npm ci
          CI=false npm run build:production

      - name: Prepare frontend artifact
        run: |
          mkdir -p build-artifacts/frontend/build
          cp -r frontend/build/* build-artifacts/frontend/build/

      - name: List artifacts
        run: |
          echo "=== Listing backend JAR ==="
          ls -la ./prod-backend.jar
          echo "=== Listing frontend build contents ==="
          ls -la build-artifacts/frontend/build

      - name: Clean app dir on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            rm -rf ~/app/*
            mkdir -p ~/app/frontend
            mkdir -p ~/app/backend

      - name: Copy frontend to EC2 (prod) - FIXED
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Use rsync to copy frontend files
          rsync -avz -e "ssh -o StrictHostKeyChecking=no" build-artifacts/frontend/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/frontend/

      - name: Copy backend JAR to EC2 (prod)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "prod-backend.jar"
          target: "/home/${{ secrets.EC2_USER }}/app/backend/"

      - name: Verify files on EC2 (prod)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Verifying files on EC2 ==="
            echo "Contents of ~/app:"
            ls -la ~/app
            echo "Contents of ~/app/frontend:"
            ls -la ~/app/frontend
            echo "Contents of ~/app/backend:"
            ls -la ~/app/backend
            echo "Contents of ~/app/frontend/build:"
            ls -la ~/app/frontend/build
            echo "Contents of ~/app/backend/*.jar:"
            ls -la ~/app/backend/*.jar

      - name: Fix Nginx Configuration (Production)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "== Fixing Nginx Configuration for Production =="
            
            # Create corrected production configuration
            sudo tee /etc/nginx/sites-available/banking > /dev/null <<EOF
            server {
                server_name banking.cyetechnology.com;

                # Static assets handling
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                    root /var/www/html;
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }

                # Frontend app
                location / {
                    root /var/www/html;
                    try_files \$uri \$uri/ /index.html;
                }

                # API
                location ^~ /api/ {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                }

                listen 443 ssl; # managed by Certbot
                ssl_certificate /etc/letsencrypt/live/banking.cyetechnology.com/fullchain.pem; # managed by Certbot
                ssl_certificate_key /etc/letsencrypt/live/banking.cyetechnology.com/privkey.pem; # managed by Certbot
                include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
            }
            server {
                if (\$host = banking.cyetechnology.com) {
                    return 301 https://\$host\$request_uri;
                } # managed by Certbot

                listen 80;
                server_name banking.cyetechnology.com;
                return 404; # managed by Certbot
            }
            EOF
            
            # Enable production site
            if [ ! -L "/etc/nginx/sites-enabled/banking" ]; then
              sudo ln -s /etc/nginx/sites-available/banking /etc/nginx/sites-enabled/
            fi
            
            # Test Nginx configuration
            sudo nginx -t
            if [ $? -ne 0 ]; then
              echo "ERROR: Nginx configuration test failed"
              exit 1
            else
              echo "✓ Nginx configuration test passed"
            fi

      - name: Deploy on EC2 (prod)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            NGINX_ROOT="/var/www/html"
            PROD_SERVICE="prod.service"
            JAR_FILE="app.jar"
            echo "== Production deploy start =="
            
            # List app contents for debug
            echo "=== Contents of $HOME/app ==="
            ls -la "$HOME/app"
            echo "=== Contents of $HOME/app/frontend ==="
            ls -la "$HOME/app/frontend"
            echo "=== Contents of $HOME/app/backend ==="
            ls -la "$HOME/app/backend"
            echo "=== Contents of $HOME/app/frontend/build ==="
            ls -la "$HOME/app/frontend/build"
            
            # Check directories exist
            if [ ! -d "$HOME/app/frontend" ]; then
                echo "ERROR: frontend directory not found"
                ls -la "$HOME/app"
                exit 1
            fi
            
            if [ ! -d "$HOME/app/backend" ]; then
                echo "ERROR: backend directory not found"
                ls -la "$HOME/app"
                exit 1
            fi
            
            # Check if frontend build exists
            if [ ! -d "$HOME/app/frontend/build" ]; then
                echo "ERROR: frontend build directory not found"
                ls -la "$HOME/app/frontend"
                exit 1
            fi
            
            # Check if index.html exists in build
            if [ ! -f "$HOME/app/frontend/build/index.html" ]; then
                echo "ERROR: index.html not found in build directory"
                ls -la "$HOME/app/frontend/build"
                exit 1
            fi
            
            # Frontend deployment
            sudo rm -rf "$NGINX_ROOT"/*
            sudo cp -r "$HOME/app/frontend/build"/* "$NGINX_ROOT"/
            sudo chown -R www-data:www-data "$NGINX_ROOT"
            
            # Verify frontend files
            if [ ! -f "$NGINX_ROOT/index.html" ]; then
                echo "ERROR: index.html not found in $NGINX_ROOT"
                ls -la "$NGINX_ROOT"
                exit 1
            fi
            
            # Backend deployment
            if [ -f "$HOME/app/backend"/*.jar ]; then
                cp "$HOME/app/backend"/*.jar "$HOME/$JAR_FILE"
                echo "JAR copied successfully to $JAR_FILE"
            else
                echo "ERROR: JAR file not found"
                ls -la "$HOME/app/backend"
                exit 1
            fi
            
            # Check if systemd service exists
            if [ ! -f "/etc/systemd/system/${PROD_SERVICE}" ]; then
                echo "ERROR: Systemd service ${PROD_SERVICE} not found"
                ls -la /etc/systemd/system/
                exit 1
            fi
            
            # Restart services
            sudo systemctl restart nginx
            sudo systemctl restart ${PROD_SERVICE}
            
            # Wait for services to start
            sleep 3
            
            # Check service status
            sudo systemctl status ${PROD_SERVICE} --no-pager -n 20
            
            # Test production site
            echo "=== Testing production site ==="
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
            echo "HTTP Status Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
                echo "✓ Production site is accessible"
                CONTENT=$(curl -s http://localhost/)
                if [ -z "$CONTENT" ]; then
                    echo "⚠ Warning: Production site returned empty content"
                else
                    echo "✓ Production site has content"
                    echo "First 100 characters:"
                    echo "$CONTENT" | head -c 100
                fi
            else
                echo "✗ Production site returned HTTP $HTTP_CODE"
                echo "=== Nginx error logs ==="
                sudo tail -n 30 /var/log/nginx/error.log
            fi
            
            # Test backend API
            echo "=== Testing backend API ==="
            API_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/actuator/health || curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health)
            echo "API HTTP Status Code: $API_HTTP_CODE"
            
            echo "== Production deploy done =="
            echo "Production URLs:"
            echo "  Frontend: https://banking.cyetechnology.com"
            echo "  Backend API: https://banking.cyetechnology.com/api"